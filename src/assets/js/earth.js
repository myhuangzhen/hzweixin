"use strict";function initEarth(e,t){earthImg=document.createElement("img"),earthImg.src="../img/anjian/earth/earth.jpg",earthImg.onload=function(){var a=document.createElement("canvas");earthCtx=a.getContext("2d"),a.width=earthImg.width,a.height=earthImg.height,earthCtx.drawImage(earthImg,0,0,earthImg.width,earthImg.height),earthImgData=earthCtx.getImageData(0,0,earthImg.width,earthImg.height),createBasicScene(e),createEarthParticles(),animate(),"function"==typeof t&&t.call(null)}}function moveTo(e,t){function a(){m&&!r?(camera.position.z<m?camera.position.z+=p:camera.position.z>m&&(camera.position.z-=p),Math.abs(m-camera.position.z)<p&&(r=!0)):r=!0,h&&!i?(earthParticles.position.x<h?earthParticles.position.x+=l:earthParticles.position.x>h&&(earthParticles.position.x-=l),Math.abs(h-earthParticles.position.x)<l&&(i=!0)):i=!0,c&&!n?(scene.position.y<c?scene.position.y+=d:scene.position.y>c&&(scene.position.y-=d),Math.abs(c-scene.position.y)<d&&(n=!0)):n=!0;var e=window.requestAnimationFrame(a);r&&i&&n&&(window.cancelAnimationFrame(e),"function"==typeof t&&t.call(null))}var r=!1,i=!1,n=!1,o=e.durtime?e.durtime:1,s=60*o,h=e.x?e.x:null,c=e.y?e.y:null,m=e.z?e.z:null,l=Math.abs(earthParticles.position.x-h)/s,d=Math.abs(earthParticles.position.y-m)/s,p=Math.abs(camera.position.z-m)/s;a()}function createBasicScene(e){var t=$(e).width(),a=$(e).height();scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(45,t/a,.1,1e4),camera.position.z=1e3,renderer=new THREE.WebGLRenderer({alpha:!0,ntialias:!0,logarithmicDepthBuffer:!0}),renderer.setSize(t,a),renderer.setClearColor(16777215,0),renderer.setClearAlpha(0),document.querySelector("#earth3d").appendChild(renderer.domElement),clock=new THREE.Clock,control=new THREE.TrackballControls(camera),control.rotateSpeed=1,control.zoomSpeed=1,control.panSpeed=1}function createEarthParticles(){for(var e=[],t=[],a=[],r=0;r<2;r++){e[r]={positions:[]},a[r]={sizes:[]},mat=new THREE.PointsMaterial,mat.size=6,mat.color=new THREE.Color(39423),mat.map=dotTexture,mat.depthWrite=!1,mat.transparent=!0,mat.opacity=0,mat.side=THREE.FrontSide,mat.blending=THREE.AdditiveBlending;var i=r/2;mat.t_=i*Math.PI*2,mat.speed_=BLINT_SPEED,mat.min_=.2*Math.random()+.5,mat.delta_=.1*Math.random()+.1,mat.opacity_coef_=1,t.push(mat)}var n=new THREE.Spherical;n.radius=radius;for(var o=250,r=0;r<o;r++)for(var s=new THREE.Vector3,h=o*(1-Math.sin(r/o*Math.PI))/o+.5,c=0;c<o;c+=h){var m=c/o,l=r/o,d=Math.floor(2*Math.random());p=e[d],u=a[d],isLandByUV(m,l)&&(n.theta=m*Math.PI*2-Math.PI/2,n.phi=l*Math.PI,s.setFromSpherical(n),p.positions.push(s.x),p.positions.push(s.y),p.positions.push(s.z),c%3===0&&u.sizes.push(6))}for(var r=0;r<e.length;r++){for(var p=e[r],u=a[r],E=new THREE.BufferGeometry,g=new Float32Array(p.positions.length),f=new Float32Array(u.sizes.length),c=0;c<p.positions.length;c++)g[c]=p.positions[c];for(var c=0;c<u.sizes.length;c++)f[c]=u.sizes[c];E.addAttribute("position",new THREE.BufferAttribute(g,3)),E.addAttribute("size",new THREE.BufferAttribute(f,1)),E.computeBoundingSphere();var I=new THREE.Points(E,t[r]);earthParticles.add(I)}scene.add(earthParticles)}function render(){var e=clock.getDelta();control.update(e),renderer.render(scene,camera)}function animate(){requestAnimationFrame(animate);var e=earthParticles.children;e.forEach(function(e){var t=e.material;t.t_+=t.speed_,t.opacity=(Math.sin(t.t_)*t.delta_+t.min_)*t.opacity_coef_,t.needsUpdate=!0}),earthParticles.rotation.y+=-.006,render()}function createPosition(e){var t=new THREE.Spherical;t.radius=radius;var a=e[0],r=e[1],i=(a+90)*(Math.PI/180),n=(90-r)*(Math.PI/180);t.phi=n,t.theta=i;var o=new THREE.Vector3;return o.setFromSpherical(t),o}function isLandByUV(e,t){earthImgData||console.error("data error!");var a=parseInt(earthImg.width*e);return o=parseInt(earthImg.height*t),0===earthImgData.data[4*(o*earthImgData.width+a)]}var CITY_RADIUS=100,BLINT_SPEED=.05,radius=100,scene,camera,renderer,clock,control,earthCtx,earthImgData,axes,mat,o,earthImg,earthParticles=new THREE.Object3D,dotTexture=(new THREE.TextureLoader).load("../img/anjian/earth/dot.png");